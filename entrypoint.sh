#!/usr/bin/env bash

function initialize() {
    cp etc/configuration.ini.sample etc/configuration.ini
    sed -i 'N;s/\[Redis\]\nHost: localhost/[Redis\]\nHost: redis/;P;D' etc/configuration.ini
    sed -i 'N;s/\[Mongo\]\nHost: localhost/[Mongo\]\nHost: mongo/;P;D' etc/configuration.ini
    sed -i 'N;s/\[Webserver\]\nHost: 127.0.0.1/[Webserver\]\nHost: 0.0.0.0/;P;D' etc/configuration.ini

    mkdir log
    time ./sbin/db_mgmt_cpe_dictionary.py -p | awk '{ print strftime("%Y-%m-%d %H:%M:%S: "), $0; fflush(); }' | tee log/db_mgmt_cpe_dictionary.log
    time ./sbin/db_mgmt_json.py -p | awk '{ print strftime("%Y-%m-%d %H:%M:%S: "), $0; fflush(); }' | tee log/db_mgmt_json.log
    time ./sbin/db_updater.py -c | awk '{ print strftime("%Y-%m-%d %H:%M:%S: "), $0; fflush(); }' | tee log/db_updater.log
}

function serve() {
    python3 ./web/index.py
}

if [[ $# = 1 && "$1" == "initialize" ]]; then
    initialize
fi

if [[ $# = 1 && "$1" == "serve" ]]; then
    serve
fi
